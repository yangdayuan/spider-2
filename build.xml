<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project [<!ENTITY buildfile SYSTEM "file:./build-user.xml">]>
<!-- WARNING: Eclipse autogenerated file. 
              Any modifications will be overwritten.
              Please edit build-user.xml instead.
-->
<project basedir="." default="release" name="pris-fetcher">
	<property name="bin.dir" value="bin" />
	<property name="lib.dir" value="lib" />
	<property name="build.dir" value="build"/>
	<property name="release.dir" value="release"/>
	<property name="release.lib" value="release/lib"/>
	<property name="release.conf" value="release/conf"/>
	<property name="ssh.keyfile" value="e:/id_rsa"/>

	<!--清理任务-->
	<target name="clean">
		<delete dir="${build.dir}"/>
	</target>
	
	<!--创建目录-->
	<target name="init" depends="clean">
		<mkdir dir="${build.dir}"/>
	</target>
	
	<path id="classpath">
		<fileset dir="${lib.dir}">
			<include name="*.jar"/>
		</fileset>		
  	</path>
	
	<target name="build" depends="init" description="Build jar">
		<jar jarfile="${build.dir}/common.jar" basedir="${bin.dir}">
			<include name="com/netease/backend/collector/rss/common/**/*.class"/>
			<exclude name="com/netease/backend/collector/rss/common/**/*Test.class"/>
		</jar>
		<jar jarfile="${build.dir}/crawler.jar" basedir="${bin.dir}">
			<include name="com/netease/backend/collector/rss/crawler/**/*.class"/>
			<include name="org/archive/crawler/**/*.class"/>
			<exclude name="com/netease/backend/collector/rss/crawler/**/*Test.class"/>
		</jar>
		<jar jarfile="${build.dir}/manager.jar" basedir="${bin.dir}">
			<include name="com/netease/backend/collector/rss/manager/**/*.class"/>
			<exclude name="com/netease/backend/collector/rss/manager/**/*Test.class"/>
		</jar>
	</target>
		
	<target name="common-release" depends="build">
		<delete>
			<fileset dir="${release.lib}" includes="*.jar"/>
		</delete>
		<copy todir="${release.lib}">
			<fileset dir="${build.dir}">
				<include name="*.jar"/>
			</fileset>	
		</copy>
		<copy todir="${release.lib}">
			<fileset dir="${lib.dir}">
				<include name="fetcher-common*.jar" />
				<include name="dcas-analyzer*.jar" />
			</fileset>	
		</copy>
	</target>
	<!--release version-->
	<target name="release" depends="common-release">
		<delete>
			<fileset dir="${release.conf}">
				<exclude name="**/.svn**" />
			</fileset>
		</delete>
		<move todir="${release.conf}">
			<fileset dir="${release.conf}">
			</fileset>
			<mapper type="regexp" from="^(.*)-online.(.*)$$" to="\1.\2" />
		</move>	
	</target>
	
	<target name="test" depends="common-release">
		<delete>
			<fileset dir="${release.dir}/test-conf">
				<exclude name="**/.svn**" />
			</fileset>
		</delete>
	</target>
	
	<!--测试服务器重新启动-->
	<target name="restart-test">
		<sshexec host="app-61.photo.163.org" port="1046"
		    username="yuedu" trust="true" keyfile="${ssh.keyfile}" 
			command="cd /home/yuedu/pris-fetcher/;svn up lib/ rss-lib/ common-conf/;
			sh duplicationFilter/bin/df.sh;sh start.sh;"/>
	</target>
	
	<!--线上升级，所有节点更新jar和conf配置文件，然后重启所有节点-->
	<target name="upgrade-online">
		<sshexec host="yuedu4.photo.163.org" port="1046"
		    username="yuedu" trust="true" keyfile="${ssh.keyfile}" 
			command="cd /home/yuedu/pris-fetcher/;svn up lib/ rss-lib/;sh start-df.sh;sh start.sh;
			 cd /mnt/hdir/0/dcas-default;sh start.sh;"/>
		<sshexec host="yuedu5.photo.163.org" port="1046"
		    username="yuedu" trust="true" keyfile="${ssh.keyfile}" 
			command="cd /mnt/hdir/0/pris-fetcher-news/;svn up lib/ rss-lib/;
			cd /home/yuedu/pris-fetcher-photo/;sh start.sh;"/>
		<sshexec host="app-57.photo.163.org" port="1046"
		    username="dir" trust="true" keyfile="${ssh.keyfile}" 
			command="cd /home/dir/pris-fetcher-2/;svn up lib/ rss-lib/;sh start.sh;
			cd ../pris-fetcher-news-2/;sh start.sh;"/>
		<sshexec host="app-48.photo.163.org" port="1046"
		    username="dir" trust="true" keyfile="${ssh.keyfile}" 
			command="cd /home/dir/pris-fetcher-2/;svn up lib/ rss-lib/;sh start.sh;"/>
	</target>

</project>
